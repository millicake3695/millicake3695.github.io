## åè¯è§£é‡Š

### é—­åŒ…

  å½“å‡½æ•°å¯ä»¥è®°ä½å¹¶è®¿é—®æ‰€åœ¨çš„è¯æ³•ä½œç”¨åŸŸæ—¶ï¼Œå°±äº§ç”Ÿäº†é—­åŒ…ï¼Œå³ä½¿å‡½æ•°æ˜¯åœ¨å½“å‰è¯æ³•ä½œç”¨åŸŸä¹‹å¤–æ‰§è¡Œã€‚

  æœ¬è´¨ï¼šæ˜¯JavaScriptå‡½æ•°ä½œç”¨åŸŸçš„å‰¯ä½œç”¨äº§å“ï¼Œä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡ã€‚

  æž„æˆï¼šå‡½æ•°ï¼Œä»¥åŠåˆ›å»ºè¯¥å‡½æ•°çš„çŽ¯å¢ƒã€‚çŽ¯å¢ƒç”±é—­åŒ…åˆ›å»ºæ—¶åœ¨ä½œç”¨åŸŸä¸­çš„ä»»ä½•å±€éƒ¨å˜é‡ç»„æˆã€‚

  å†…å­˜æ³„æ¼ï¼šå› ä¸ºé—­åŒ…å¯ä»¥ä½¿å‡½æ•°ä¸­çš„å˜é‡éƒ½ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé€ æˆå¾ˆå¤§çš„å†…å­˜æ¶ˆè€—ã€‚

  ä½¿ç”¨ä¸å½“çš„é—­åŒ…ä¼šåœ¨`IE(IE9)`ä¹‹å‰é€ æˆå†…å­˜æ³„æ¼é—®é¢˜ã€‚å› ä¸ºå®ƒçš„`JavaScriptå¼•æ“Ž`ä½¿ç”¨çš„åžƒåœ¾å›žæ”¶ç®—æ³•æ˜¯å¼•ç”¨è®¡æ•°æ³•ï¼Œå¯¹äºŽå¾ªçŽ¯å¼•ç”¨å°†ä¼šå¯¼è‡´GCæ— æ³•å›žæ”¶åžƒåœ¾ã€‚

  åžƒåœ¾å›žæ”¶`GC(Garbage Collection)`æŠŠç¨‹åºä¸ç”¨çš„å†…å­˜ç©ºé—´è§†ä¸ºåžƒåœ¾ï¼Œæ‰¾åˆ°å¹¶ä¸”å°†å®ƒä»¬å›žæ”¶ï¼Œä»¥ä¾¿å†æ¬¡ä½¿ç”¨ã€‚

  ä¸æ˜¯æ‰€æœ‰çš„è¯­è¨€éƒ½æœ‰`GC`ï¼Œä¸€èˆ¬å­˜åœ¨äºŽé«˜çº§è¯­è¨€ä¸­ï¼Œå¦‚`Java`ã€`JavaScript`ã€`Python`ã€‚é‚£ä¹ˆåœ¨æ²¡æœ‰`GC`çš„ä¸–ç•Œé‡Œï¼Œç¨‹åºå‘˜å°±æ¯”è¾ƒè¾›è‹¦ï¼Œåªèƒ½æ‰‹åŠ¨åŽ»ç®¡ç†å†…å­˜ï¼Œæ¯”å¦‚åœ¨Cè¯­è¨€ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡`malloc/free`ï¼Œåœ¨`C++`ä¸­çš„`new/delete`æ¥è¿›è¡Œç®¡ç†ã€‚


### åžƒåœ¾æ¸…é™¤ç®—æ³•

1. GCæ ‡è®°-æ¸…é™¤ç®—æ³•

  GCæ ‡è®°-æ¸…é™¤ç®—æ³•ç”±æ ‡è®°é˜¶æ®µå’Œæ¸…é™¤é˜¶æ®µæž„æˆï¼Œæ ‡è®°é˜¶æ®µå°†æ‰€æœ‰çš„æ´»åŠ¨å¯¹è±¡åšä¸Šç›¸åº”çš„æ ‡è®°ï¼Œæ¸…é™¤é˜¶æ®µæŠŠé‚£äº›æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯éžæ´»åŠ¨å¯¹è±¡è¿›è¡Œå›žæ”¶ã€‚åœ¨æœç´¢å¯¹è±¡å¹¶è¿›è¡Œæ ‡è®°çš„æ—¶å€™ä½¿ç”¨äº†æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œå°½å¯èƒ½çš„ä»Žæ·±åº¦ä¸Šæœç´¢æ ‘å½¢ç»“æž„ã€‚

  - ä¼˜ç‚¹ï¼š  
  (1). ç®—æ³•ç®€å•ï¼Œå®žçŽ°å®¹æ˜“ã€‚  
  (2). ä¸Žä¿å®ˆå¼çš„GCç®—æ³•å…¼å®¹ã€‚  

  - ç¼ºç‚¹ï¼š  
  (1). åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šå‡ºçŽ°ç¢Žç‰‡åŒ–çš„æƒ…å†µï¼Œå¦‚åŒWindowsçš„æ–‡ä»¶ç³»ç»Ÿä¸€æ ·ï¼Œå¯¼è‡´æ— æ•°çš„å°åˆ†å—æ•£å¸ƒåœ¨å †çš„å„ä¸ªåœ°æ–¹ã€‚  
  (2). åˆ†é…é€Ÿåº¦ï¼Œç”±äºŽåˆ†å—çš„ä¸è¿žç»­æ€§ï¼Œç®—æ³•æ¯æ¬¡åˆ†é…çš„æ—¶å€™éƒ½éœ€è¦éåŽ†ç©ºé—²é“¾è¡¨ä¸ºäº†æ‰¾åˆ°è¶³å¤Ÿå¤§çš„åˆ†å—ï¼Œè¿™æ ·æœ€ç³Ÿç³•çš„æƒ…å†µå°±æ˜¯éåŽ†åˆ°æœ€åŽæ‰æ‰¾åˆ°åˆé€‚çš„åˆ†å—ï¼Œå½±å“äº†åˆ†é…é€Ÿåº¦ã€‚  

2. å¼•ç”¨è®¡æ•°æ³•

  è¿™ç§æ–¹æ³•ä¸­å¼•å…¥äº†è®¡æ•°å™¨çš„æ¦‚å¿µï¼Œé€šè¿‡è®¡æ•°å™¨æ¥è¡¨ç¤ºå¯¹è±¡çš„â€œäººæ°”æŒ‡æ•°â€ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªç¨‹åºå¼•ç”¨äº†è¿™ä¸ªå¯¹è±¡ã€‚å½“è®¡æ•°å™¨(å¼•ç”¨æ•°)ä¸º0æ—¶ï¼Œåžƒåœ¾ç«‹åˆ»è¢«å›žæ”¶ã€‚

  - ä¼˜ç‚¹ï¼š  
  (1). å¯ä»¥ç«‹å³å›žæ”¶åžƒåœ¾ã€‚  
  (2). æœ€å¤§æš‚åœçš„æ—¶é—´çŸ­ã€‚  
  (3). å¹¶ä¸”æ²¡æœ‰å¿…è¦æ²¿æŒ‡é’ˆæŸ¥æ‰¾ã€‚  

  - ç¼ºç‚¹ï¼š  
  (1). å¾ªçŽ¯å¼•ç”¨ï¼ˆå¦‚é—­åŒ…ï¼‰æ— æ³•å›žæ”¶ã€‚  
  (2). å®žçŽ°èµ·æ¥å¾ˆå¤æ‚ã€‚  
  (3). è®¡æ•°å™¨å€¼çš„å¢žå‡å¤„ç†ååˆ†ç¹é‡ã€‚  
  (4). åŒæ—¶è®¡æ•°å™¨éœ€è¦å å¾ˆå¤šä½ï¼Œå¯¼è‡´å†…å­˜ç©ºé—´çš„ä½¿ç”¨æ•ˆçŽ‡å¤§å¤§é™ä½Žã€‚  

  [jsé—­åŒ…æµ‹è¯•](https://www.cnblogs.com/rubylouvre/p/3345294.html)


### å‡½æ•°æŸ¯é‡ŒåŒ–

  ```js
  // Number | String | Boolean | Object | Array | Undefined | Null
  // Function | RegExp
  // Symbol | Set | WeakSet | Map | WeakMap
  const isType = type => target => `[object ${type}]` === Object.prototype.toString.call(target);
  ```


### Event Loop äº‹ä»¶å¾ªçŽ¯

  ðŸŒŸæŽ¨èé˜…è¯» â€”â€” [JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)

  æµè§ˆå™¨çš„äº‹ä»¶å¾ªçŽ¯æ˜¯HTML5å®šä¹‰çš„è§„èŒƒï¼ŒNodeçš„äº‹ä»¶å¾ªçŽ¯æ˜¯libuvåº“å®žçŽ°çš„ã€‚äºŒè€…åŸºæœ¬ä¸€è‡´ã€‚

  JavaScriptä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¾é å‡½æ•°è°ƒç”¨æ ˆæ¥æžå®šå‡½æ•°çš„æ‰§è¡Œé¡ºåºå¤–ï¼Œè¿˜ä¾é ä»»åŠ¡é˜Ÿåˆ—( task queue )æ¥æžå®šå¦å¤–ä¸€äº›ä»£ç çš„æ‰§è¡Œã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¸ºäº‹ä»¶å¾ªçŽ¯è¿‡ç¨‹ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œäº‹ä»¶å¾ªçŽ¯æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥æ‹¥æœ‰å¤šä¸ªã€‚ä»»åŠ¡é˜Ÿåˆ—åˆåˆ†ä¸º macro-taskï¼ˆå®ä»»åŠ¡ï¼‰ä¸Ž micro-taskï¼ˆå¾®ä»»åŠ¡ï¼‰ï¼Œåœ¨æœ€æ–°æ ‡å‡†ä¸­ï¼Œå®ƒä»¬è¢«åˆ†åˆ«ç§°ä¸ºtaskä¸Žjobsã€‚ 

  ::: warning åˆ†ç±»
  macro-taskå¤§æ¦‚åŒ…æ‹¬ï¼š`script(æ•´ä½“ä»£ç )`, `setTimeout`, `setInterval`, `setImmediate`, `I/O`, `UI rendering`  

  micro-taskå¤§æ¦‚åŒ…æ‹¬: `process.nextTick`, `Promise.then`, `Async/Await(å®žé™…å°±æ˜¯promise)`, `Object.observe`, `MutationObserver(html5æ–°ç‰¹æ€§)`
  :::

  #### äº‹ä»¶å¾ªçŽ¯çš„æ‰§è¡Œæµç¨‹ï¼š

  (1) æ£€æŸ¥ `Macrotask` é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º,è‹¥ä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™è·³åˆ°3

  (2) ä»Ž `Macrotask` é˜Ÿåˆ—ä¸­å–é˜Ÿé¦–(åœ¨é˜Ÿåˆ—æ—¶é—´æœ€é•¿)çš„ä»»åŠ¡è¿›åŽ»æ‰§è¡Œæ ˆä¸­æ‰§è¡Œ(ä»…ä»…ä¸€ä¸ª)ï¼Œæ‰§è¡Œå®ŒåŽè¿›å…¥ä¸‹ä¸€æ­¥

  (3) æ£€æŸ¥ `Microtask` é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™ï¼Œè·³åˆ°1ï¼ˆå¼€å§‹æ–°çš„äº‹ä»¶å¾ªçŽ¯ï¼‰

  (4) ä»Ž `Microtask` é˜Ÿåˆ—ä¸­å–é˜Ÿé¦–(åœ¨é˜Ÿåˆ—æ—¶é—´æœ€é•¿)çš„ä»»åŠ¡è¿›åŽ»äº‹ä»¶é˜Ÿåˆ—æ‰§è¡Œ,æ‰§è¡Œå®ŒåŽï¼Œè·³åˆ°3ã€‚å…¶ä¸­ï¼Œåœ¨æ‰§è¡Œä»£ç è¿‡ç¨‹ä¸­æ–°å¢žçš„`microtask`ä»»åŠ¡ä¼šåœ¨å½“å‰äº‹ä»¶å¾ªçŽ¯å‘¨æœŸå†…æ‰§è¡Œï¼Œè€Œæ–°å¢žçš„`macrotask`ä»»åŠ¡åªèƒ½ç­‰åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªçŽ¯æ‰èƒ½æ‰§è¡Œäº†ã€‚

  ::: tip æ‰§è¡Œé¡ºåº
  `script(ä¸»ç¨‹åºä»£ç )` => `process.nextTick` => `Promise.then...` => `setTimeout` => `setInterval` => `setImmediate` => `I/O` => `UI rendering`
  :::

  âš ï¸ ä¸€å¼€å§‹jsä¸»çº¿ç¨‹ä¸­è·‘çš„ä»»åŠ¡æ˜¯ `macrotask` ä»»åŠ¡ã€‚

  âš ï¸ ä¸€æ¬¡äº‹ä»¶å¾ªçŽ¯åªæ‰§è¡Œ`ä¸€ä¸ª`å¤„äºŽ `Macrotask` é˜Ÿé¦–çš„ä»»åŠ¡ï¼Œæ‰§è¡Œå®ŒæˆåŽï¼Œç«‹å³æ‰§è¡Œ `Microtask` é˜Ÿåˆ—ä¸­çš„`æ‰€æœ‰`ä»»åŠ¡ã€‚

  âš ï¸ setImmediate å’Œ process.nextTick æ˜¯ Node ç‹¬æœ‰çš„ã€‚ä¸è¦åœ¨é¢å‘webçš„ç”Ÿäº§ç«™ç‚¹ä¸Šä½¿ç”¨ setImmediateï¼

  è¯¥åŠŸèƒ½å¯ä»¥é€šè¿‡å‡ ç§ä¸åŒçš„æ–¹å¼è¿›è¡Œä»¿çœŸï¼š

  `postMessage` å¯ç”¨äºŽè§¦å‘ç«‹å³äº§ç”Ÿçš„å›žè°ƒã€‚è¯·æ³¨æ„ï¼ŒInternet Explorer 8åŒ…å«çš„åŒæ­¥ç‰ˆæœ¬postMessageï¼Œè¿™æ„å‘³ç€å®ƒä¸èƒ½ç”¨ä½œåŽå¤‡ã€‚ 

  `MessageChannel` å¯ä»¥åœ¨Web Workerså†…éƒ¨å¯é åœ°ä½¿ç”¨ï¼Œè€ŒpostMessageçš„è¯­ä¹‰æ„å‘³ç€å®ƒä¸èƒ½åœ¨å…¶ä¸­ä½¿ç”¨ã€‚

  `setTimeout(fn, 0)` å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ç”±äºŽHTMLè§„èŒƒå°†è®¡æ—¶å™¨åµŒå¥—åœ¨5å±‚ä»¥ä¸Šï¼Œå› æ­¤è®¡æ—¶å™¨çš„æ—¶é—´é™åˆ¶ä¸º4æ¯«ç§’ï¼Œå› æ­¤æ— æ³•è‡ªç„¶é€‚åº”setImmediateã€‚

  [å»¶ä¼¸é˜…è¯»](https://developer.mozilla.org/en-US/docs/Web/API/Window/setImmediate)

  âš ï¸ å®šä¹‰promiseçš„æž„é€ éƒ¨åˆ†æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚

  æ€»çš„ç»“è®ºå°±æ˜¯ï¼Œæ‰§è¡Œå®ä»»åŠ¡ï¼Œç„¶åŽæ‰§è¡Œè¯¥å®ä»»åŠ¡äº§ç”Ÿçš„å¾®ä»»åŠ¡ï¼Œè‹¥å¾®ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åŽï¼Œå†å›žåˆ°å®ä»»åŠ¡ä¸­è¿›è¡Œä¸‹ä¸€è½®å¾ªçŽ¯ã€‚

  âš ï¸ [setTimeout](https://mp.weixin.qq.com/s/7qTRSMqaqG8XZ9rpEBhYNQ)

  å¦‚æžœå½“å‰ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡ä¹…ï¼Œä¼šå»¶è¿Ÿåˆ°æœŸå®šæ—¶å™¨ä»»åŠ¡çš„æ‰§è¡Œã€‚

  å¦‚æžœ setTimeout å­˜åœ¨åµŒå¥—è°ƒç”¨ï¼Œè°ƒç”¨è¶…è¿‡5æ¬¡åŽï¼Œç³»ç»Ÿä¼šè®¾ç½®æœ€çŸ­æ‰§è¡Œæ—¶é—´é—´éš”ä¸º 4 æ¯«ç§’ã€‚ä¹‹æ‰€ä»¥å‡ºçŽ°è¿™æ ·çš„æƒ…å†µï¼Œæ˜¯å› ä¸ºåœ¨ Chrome ä¸­ï¼Œå®šæ—¶å™¨è¢«åµŒå¥—è°ƒç”¨ 5 æ¬¡ä»¥ä¸Šï¼Œç³»ç»Ÿä¼šåˆ¤æ–­è¯¥å‡½æ•°æ–¹æ³•è¢«é˜»å¡žäº†ï¼Œå¦‚æžœå®šæ—¶å™¨çš„è°ƒç”¨æ—¶é—´é—´éš”å°äºŽ 4 æ¯«ç§’ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šå°†æ¯æ¬¡è°ƒç”¨çš„æ—¶é—´é—´éš”è®¾ç½®ä¸º 4 æ¯«ç§’ã€‚å¯ä»¥çœ‹ä¸‹[æºç ](https://cs.chromium.org/chromium/src/third_party/blink/renderer/core/frame/dom_timer.cc)

  ä½¿ç”¨ setTimeout è®¾ç½®çš„å›žè°ƒå‡½æ•°ä¸­çš„ this çŽ¯å¢ƒä¸æ˜¯æŒ‡å‘å›žè°ƒå‡½æ•°ã€‚

  Chromeã€Safariã€Firefox éƒ½æ˜¯ä»¥ 32 ä¸ª bit æ¥å­˜å‚¨å»¶æ—¶å€¼çš„ï¼Œ32bit æœ€å¤§åªèƒ½å­˜æ”¾çš„æ•°å­—æ˜¯ 2147483647 æ¯«ç§’ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå¦‚æžœ setTimeout è®¾ç½®çš„å»¶è¿Ÿå€¼å¤§äºŽ 2147483647 æ¯«ç§’ï¼ˆå¤§çº¦ 24.8 å¤©ï¼‰æ—¶å°±ä¼šæº¢å‡ºï¼Œè¿™å¯¼è‡´å®šæ—¶å™¨ä¼šè¢«ç«‹å³æ‰§è¡Œã€‚

  ```js
    async function async1() {
      await async2();
      console.log('async1 end');
    }
    async function async2() {
      console.log('async2 end');
    }
    async1();

    setTimeout(() => {
      console.log('setTimeout');
    }, 0);
    new Promise(resolve => {
      console.log('Promise'); // Promise æ–°å»ºåŽå°±ä¼šç«‹å³æ‰§è¡Œã€‚
      resolve();
    }).then(() => {
      console.log('Promise1');
    }).then(() => {
      console.log('Promise2');
    });
    // async2 end => Promise => async1 end => Promise1 => Promise2 => setTimeout
  ```